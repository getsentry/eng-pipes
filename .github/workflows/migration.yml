# This workflow allow you to run migrations from GitHub UI

name: Migration

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'The migration to run'
        required: false
        default: 'latest'
      environment:
        description: 'The database environment to run migration on'
        required: false
        default: 'production'

jobs:
  run:
    name: run migration
    runs-on: ubuntu-latest
    environment: migration

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup node
      uses: actions/setup-node@v1
      with:
        node-version: '12'

    - name: yarn install
      run: |
        echo "$(yarn global bin)" >> $GITHUB_PATH
        yarn install --frozen-lockfile

    # Setup gcloud CLI
    - name: Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@master
      with:
        service_account_email: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
        service_account_key: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        export_default_credentials: true

    # Build ts
    - name: Run migration
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
        chmod +x cloud_sql_proxy
        ./cloud_sql_proxy -instances=${{ secrets.DB_INSTANCE_CONNECTION_NAME }}=tcp:5432 -dir . &
        yarn knex migrate:${{ github.event.inputs.name }} --env ${{ github.event.inputs.environment }}
