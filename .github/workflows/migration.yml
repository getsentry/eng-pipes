# This workflow allow you to run migrations from GitHub UI

name: Migration

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'The migration to run'
        required: false
        default: 'latest'
      environment:
        description: 'The database environment to run migration on'
        required: false
        default: 'production'

jobs:
  run:
    name: run migration
    runs-on: ubuntu-latest
    environment: migration
    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_INSTANCE_CONNECTION_NAME: ${{ secrets.DB_INSTANCE_CONNECTION_NAME }}

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup node
      uses: actions/setup-node@v1
      with:
        node-version: '12'

    - name: yarn install
      run: |
        echo "$(yarn global bin)" >> $GITHUB_PATH
        yarn install --frozen-lockfile

    # Build ts
    - name: Run migration
      run: |
        yarn knex migrate:${{ github.event.inputs.name }} --env ${{ github.event.inputs.environment }}
